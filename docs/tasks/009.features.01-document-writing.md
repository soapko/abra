# 009.features.01: Document Writing Capability

**Status:** Pending
**Priority:** High

## Objective

Enable the simulated persona to write, read, update, and append to documents during their session, allowing use cases like "Find a laptop and document your search journey."

## Context

Abra simulates personas navigating websites to achieve goals. Currently, all outputs are passive (videos, transcripts). This feature adds an active output capability where the persona can create and maintain documents based on cues in their goal text (e.g., "document your findings", "create a comparison chart").

**User Requirements:**
- **Output path**: Session directory (`sessions/<session>/docs/`)
- **Config style**: LLM-driven - persona decides when/what to document based on goal text
- **Operations**: Full CRUD (create, read, update, append)
- **Formats**: Markdown, JSON, and custom extensions

## Technical Details

### Files to Modify

| File | Changes |
|------|---------|
| `src/lib/llm.ts` | Add `document` action type, extend Action interface, update system prompts |
| `src/lib/action-executor.ts` | Add document case to switch, update function signature |
| `src/lib/session.ts` | Initialize DocumentWriter, pass to executor, include document index in LLM calls |
| `src/lib/document-writer.ts` | **NEW** - Document CRUD operations module |
| `src/index.ts` | Export new types |

### Implementation Steps

#### Step 1: Create Document Writer Module

Create `src/lib/document-writer.ts`:

```typescript
export interface DocumentInfo {
  filename: string;
  format: 'markdown' | 'json' | 'text';
  sizeBytes: number;
  preview: string;  // First ~200 chars
  sections?: string[];  // For markdown, list of headings
}

export class DocumentWriter {
  constructor(sessionDir: string);
  async initialize(): Promise<void>;
  async create(filename: string, content: string): Promise<DocumentWriteResult>;
  async read(filename: string): Promise<{ success: boolean; content?: string; error?: string }>;
  async update(filename: string, content: string, section?: string): Promise<DocumentWriteResult>;
  async append(filename: string, content: string): Promise<DocumentWriteResult>;
  getIndex(): DocumentInfo[];
  formatIndexForLLM(): string;
}
```

Key behaviors:
- Creates `docs/` subdirectory in session folder
- Sanitizes filenames to prevent path traversal
- Validates JSON before writing `.json` files
- Caps document size at 100KB
- For markdown `update` with section: replaces content under heading until next heading

#### Step 2: Update LLM Types (`src/lib/llm.ts`)

Add to ActionType (line 22):
```typescript
export type ActionType = 'click' | 'type' | 'press' | 'scroll' | 'hover' | 'wait' | 'done' | 'failed' | 'document';
```

Add DocumentOperation type:
```typescript
export type DocumentOperation = 'create' | 'read' | 'update' | 'append';
```

Extend Action interface (lines 24-42):
```typescript
document?: {
  operation: DocumentOperation;
  filename: string;
  content?: string;
  section?: string;  // For update - target heading or JSON path
};
```

#### Step 3: Update System Prompt (`src/lib/llm.ts`)

Add documentation instructions to `buildSystemPrompt()` (after line 92):

```
DOCUMENT ACTIONS:
You can create and maintain documents to record your findings.

- create: Start a new document
  {"type": "document", "document": {"operation": "create", "filename": "notes.md", "content": "# Notes\n..."}}

- read: Read existing document (content available in next step)
  {"type": "document", "document": {"operation": "read", "filename": "notes.md"}}

- update: Replace content (optionally target a section by heading)
  {"type": "document", "document": {"operation": "update", "filename": "notes.md", "content": "...", "section": "## Findings"}}

- append: Add to end of document
  {"type": "document", "document": {"operation": "append", "filename": "notes.md", "content": "\n## New Section\n..."}}

Formats: .md, .json, .txt, or custom extensions.
Document when your goal mentions: document, record, note, track, log, compare.
```

#### Step 4: Update User Prompt (`src/lib/llm.ts`)

Modify `buildUserPrompt()` (line 98) to accept and include document index:
```typescript
function buildUserPrompt(
  goal: string,
  pageState: PageState,
  previousActions: string[],
  documentIndex?: string
): string
```

Add section:
```
AVAILABLE DOCUMENTS:
<document index here>
```

Update `getNextAction()` and `getNextActionFromScreenshot()` signatures to accept `documentIndex`.

#### Step 5: Update Action Executor (`src/lib/action-executor.ts`)

Update `executeAction()` signature (line 94):
```typescript
export async function executeAction(
  browser: Browser,
  action: Action,
  elements: PageElement[],
  documentWriter?: DocumentWriter
): Promise<ExecutionResult>
```

Add case in switch (after line 228):
```typescript
case 'document': {
  if (!action.document || !documentWriter) {
    throw new Error('Document action requires document config and writer');
  }
  const { operation, filename, content, section } = action.document;

  switch (operation) {
    case 'create':
      await documentWriter.create(filename, content!);
      break;
    case 'read':
      await documentWriter.read(filename);
      break;
    case 'update':
      await documentWriter.update(filename, content!, section);
      break;
    case 'append':
      await documentWriter.append(filename, content!);
      break;
  }
  break;
}
```

Update `formatAction()` and `formatVisionAction()` for document actions.

#### Step 6: Update Session Orchestrator (`src/lib/session.ts`)

In `runSession()`:
```typescript
const documentWriter = new DocumentWriter(sessionDir);
await documentWriter.initialize();
```

In `runGoal()`:
- Pass `documentWriter` as parameter
- Get document index before LLM calls: `const docIndex = documentWriter.formatIndexForLLM();`
- Pass to `getNextAction()` and `getNextActionFromScreenshot()`
- Pass to `executeAction()`

#### Step 7: Update Exports (`src/index.ts`)

```typescript
export { DocumentWriter, type DocumentInfo } from './lib/document-writer.js';
export type { DocumentOperation } from './lib/llm.js';
```

## Acceptance Criteria

- [ ] Persona can create markdown documents during session
- [ ] Persona can create JSON documents during session
- [ ] Persona can read existing documents (content available in next iteration)
- [ ] Persona can update specific sections of markdown documents
- [ ] Persona can append content to existing documents
- [ ] Documents are saved to `sessions/<session>/docs/`
- [ ] LLM sees list of available documents in each iteration
- [ ] Works in both standard and sight mode
- [ ] Filename sanitization prevents path traversal
- [ ] JSON files are validated before writing

## Testing

### Manual Test Cases

1. **Create markdown**: Goal "Search for laptops and document your top 3 picks"
   - Expected: `docs/laptop-picks.md` (or similar) created with findings

2. **Append to document**: Goal with multiple phases requiring ongoing notes
   - Expected: Document grows as persona finds new information

3. **Update section**: Goal requiring comparison updates
   - Expected: Specific section replaced without affecting other content

4. **JSON output**: Goal "Create a JSON summary of product prices"
   - Expected: Valid JSON file created

5. **Read and update**: Goal requiring persona to review and revise notes
   - Expected: Persona reads existing doc, then updates it

### Integration Test

Create test persona:
```yaml
persona:
  name: Research Assistant
  background: Methodical researcher who documents findings
  jobs_to_be_done:
    - Gather comprehensive information
    - Organize findings in structured documents

url: https://example.com

goals:
  - Find information about the company and document your findings in a markdown file
```

Verify `sessions/<session>/docs/` contains expected document(s).
