# 007.bugfix.01: Unique Selector Generation with Coordinate Fallback

**Status:** In Progress
**Priority:** High
**Branch:** `feature/sight-based-analysis`

## Problem

When multiple elements share the same `data-testid` or other attributes, the generated selector matches multiple elements, causing Puppeteer's strict mode to reject the click.

Example error from Reddit test:
```
Error: strict mode violation: locator('[data-testid="subreddit-name"]') resolved to 28 elements
```

## Root Cause

The `getSelector()` function in `page-analyzer.ts` returns the first matching attribute without checking uniqueness:
```javascript
const testId = el.getAttribute('data-testid');
if (testId) return testId;  // Returns even if 28 elements have same testid
```

## Solution

1. **Improve selector generation** - Combine attributes to create unique selectors
2. **Add coordinate fallback** - When selector fails, click at element's center coordinates

## Implementation

### 1. Smarter Selector Generation (page-analyzer.ts)

Build selectors that combine multiple attributes when single attribute isn't unique:

```javascript
const getSelector = (el) => {
  // Try simple selectors first
  const candidates = [];

  if (el.id) candidates.push('#' + CSS.escape(el.id));

  const testId = el.getAttribute('data-testid');
  if (testId) candidates.push(`[data-testid="${testId}"]`);

  // Check if any candidate is unique
  for (const sel of candidates) {
    if (document.querySelectorAll(sel).length === 1) {
      return sel;
    }
  }

  // Combine attributes for uniqueness
  const tag = el.tagName.toLowerCase();
  let selector = tag;

  if (testId) selector += `[data-testid="${testId}"]`;
  if (el.href) selector += `[href="${el.getAttribute('href')}"]`;

  if (document.querySelectorAll(selector).length === 1) {
    return selector;
  }

  // Use nth-of-type as last resort
  // ...
};
```

### 2. Coordinate Fallback (action-executor.ts)

When selector-based click fails, fall back to clicking at element center coordinates:

```javascript
async function executeClick(browser, selector, bounds) {
  try {
    await browser.click(selector);
  } catch (err) {
    if (err.message.includes('strict mode violation') && bounds) {
      // Fall back to coordinate click
      const x = bounds.x + bounds.width / 2;
      const y = bounds.y + bounds.height / 2;
      await browser.clickAt(x, y);
    } else {
      throw err;
    }
  }
}
```

### 3. Store Bounds in Action (session.ts)

Pass element bounds through to action executor for coordinate fallback:

```javascript
actionToExecute = {
  ...visionResult.action,
  elementId: targetElement?.id,
  selector: targetElement?.selector,
  bounds: targetElement?.bounds,  // Add this
};
```

## Files to Modify

1. `src/lib/page-analyzer.ts` - Improve getSelector() to check uniqueness
2. `src/lib/action-executor.ts` - Add coordinate fallback for failed clicks
3. `src/lib/session.ts` - Pass bounds through to action executor

## Testing

1. Run Reddit sloth search test - should now click r/sloths dropdown
2. Verify DuckDuckGo test still works
3. Test on pages with duplicate data-testid attributes

## Acceptance Criteria

- [ ] Selector generation checks for uniqueness before returning
- [ ] Combined selectors use multiple attributes when needed
- [ ] Click falls back to coordinates when selector is ambiguous
- [ ] Reddit test can click on search suggestions
- [ ] Existing tests continue to pass
