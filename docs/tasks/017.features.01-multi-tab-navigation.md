# Task 23: Multi-Tab Navigation

## Problem

Abra personas can only interact within a single page. They cannot navigate to a different URL or manage multiple browser tabs. This blocks realistic multi-site workflows like:

- Create an account on `site.com`, navigate to `gmail.com` to verify email, click verification link
- Compare products across multiple retailer websites
- Fill out a form that requires copying information from another site

The current `Browser` interface has no `goto`, and there are no tab management methods. All actions assume a single-page context.

## Design

### Layer 1: Navigate Action (Abra only)

Add a `navigate` action type that calls `browser.goto(url)`. The LLM can now say "go to gmail.com" mid-session without needing a link to click.

**Changes:**
- `Browser` interface: add `goto?(url: string): Promise<void>`
- `ActionType`: add `'navigate'`
- `Action`: add `url?: string` field
- Action executor: handle `navigate` → call `browser.goto(url)`
- LLM prompts: explain `navigate` action
- CLI: wire `goto` from Puppet (already available as `browserSession.goto`)

### Layer 2: Multi-Tab Support (Puppet + Abra)

Add tab management so personas can open new tabs, switch between them, and close tabs. All tabs share the same browser context (cookies, session storage).

**Puppet changes (types.ts, session.ts, fluent.ts):**
- New commands: `newTab`, `switchTab`, `closeTab`, `listTabs`
- Tab tracking via `Map<string, Page>` in session handler
- `switchTab` updates the active `page`, `currentFrame`, and `cursor`
- `newTab` creates page via `context.newPage()`, assigns auto-incrementing ID
- `closeTab` closes page, switches to another tab if closing active tab
- `listTabs` returns `{ id, url, title, active }` for all open tabs

**Abra changes (action-executor.ts, llm.ts, session.ts, cli.ts):**
- `Browser` interface: add optional `newTab`, `switchTab`, `closeTab`, `listTabs`
- New action types: `newTab`, `switchTab`, `closeTab`
- `Action`: add `url?: string` and `tabId?: string` fields
- LLM prompts: explain tab management, include OPEN TABS section in prompt
- Session: query `listTabs()` before each LLM call, inject tab list into prompt
- After `switchTab`/`newTab`: re-inject speech bubble (different page context)
- CLI: wire all Puppet tab methods to Browser interface

### Tab Info in LLM Prompt

When multiple tabs are open, the prompt includes:

```
OPEN TABS:
  [1] (active) https://example.com/signup — "Sign Up | Example"
  [2] https://gmail.com/inbox — "Inbox - Gmail"
```

### Action Examples

```json
{"type": "navigate", "url": "https://gmail.com"}
{"type": "newTab", "url": "https://gmail.com"}
{"type": "switchTab", "tabId": "1"}
{"type": "closeTab", "tabId": "2"}
```

### Bail-Out Behavior

- `navigate` triggers URL-changed bail in batch execution (same as clicking a link)
- `newTab` and `switchTab` also trigger bail (page context changes)
- These should be the LAST action in a batch, or the only action

## Implementation Steps

### Step 1: Puppet — Add tab commands to types
- File: `/Users/karl/Documents/_Projects/puppet/src/types.ts`
- Add `'newTab' | 'switchTab' | 'closeTab' | 'listTabs'` to `CommandAction`

### Step 2: Puppet — Add tab handlers to session
- File: `/Users/karl/Documents/_Projects/puppet/src/session.ts`
- Add tab tracking variables (`tabs` Map, `tabCounter`, `activeTabId`)
- Replace `page.on('close')` with tab-aware handler
- Add `newTab`, `switchTab`, `closeTab`, `listTabs` cases to command switch

### Step 3: Puppet — Add fluent API methods
- File: `/Users/karl/Documents/_Projects/puppet/src/fluent.ts`
- Add `newTab(url?)`, `switchTab(tabId)`, `closeTab(tabId?)`, `listTabs()`

### Step 4: Abra — Extend Browser interface + action executor
- File: `src/lib/action-executor.ts`
- Add optional methods to Browser interface
- Add `navigate`, `newTab`, `switchTab`, `closeTab` cases

### Step 5: Abra — Update LLM types and prompts
- File: `src/lib/llm.ts`
- Extend `ActionType` with new types
- Add `url?`, `tabId?` to `Action` interface
- Update both system prompts with tab instructions
- Update `buildUserPrompt` and `buildVisionUserPrompt` to accept tab info
- Update `formatAction`/`formatVisionAction`

### Step 6: Abra — Update session orchestrator
- File: `src/lib/session.ts`
- Query `listTabs()` before each LLM call when tabs are available
- Format tab list for prompt injection
- Re-inject speech bubble after tab switch (different page context)
- Handle navigate/tab actions appropriately in batch bail logic

### Step 7: Abra — Wire up CLI
- File: `src/cli.ts`
- Map Puppet's new tab methods to Browser interface

### Step 8: Abra — Update exports
- File: `src/index.ts`
- Export any new types

## Testing

- Create a multi-site persona that navigates between two sites
- Verify tab creation, switching, and closing work
- Verify speech bubble re-initializes on tab switch
- Verify video recording captures all tabs
- Verify batch bail triggers on navigate/tab-switch actions

## Dependencies

- None (builds on existing architecture)

## Replaces

- Nothing (new feature)
