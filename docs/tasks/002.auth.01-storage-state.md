# 002.auth.01 — Native Browser Auth State Support

## Problem

Abra cannot test pages behind OAuth (e.g., Google OAuth, claude.ai) without the user keeping a separate Chrome instance open with `--remote-debugging-port`. This makes multi-session testing of authenticated pages cumbersome and fragile.

Playwright natively supports `storageState` — saving and restoring browser cookies + localStorage from a JSON file — but abra doesn't expose this capability.

## Goal

Allow abra personas to run against authenticated pages by:
1. Providing a CLI command to capture auth state (opens a browser, user logs in, state is saved to a JSON file)
2. Supporting a `storageState` config in persona YAML files that loads saved auth before navigating
3. Optionally supporting `connectOverCDP` for connecting to an already-running Chrome instance

## Proposed Approach

### 1. Auth Capture Command

New CLI command: `abra auth <name>`

- Opens a visible Chromium browser to a blank page
- Prints instructions: "Log in to the site you need, then press ENTER in this terminal"
- On ENTER, saves `context.storageState()` to `~/.abra/auth/<name>.json`
- Closes the browser

Example:
```bash
abra auth google
# → Browser opens, user logs into Google, presses ENTER
# → Saved to ~/.abra/auth/google.json
```

### 2. Persona Config: `auth` field

Add an optional `auth` field to persona YAML:

```yaml
name: "Shane"
role: "BDR at a SaaS company"
url: "https://app.example.com/dashboard"
auth:
  storageState: "google"  # references ~/.abra/auth/google.json
```

Or with an absolute path:
```yaml
auth:
  storageState: "/path/to/auth-state.json"
```

Or connecting to an existing Chrome via CDP:
```yaml
auth:
  cdpUrl: "http://localhost:9222"
```

### 3. Session Integration

In `src/lib/session.ts` (or wherever Playwright browser/context is created):

- If `auth.storageState` is set: resolve the path, pass it to `browser.newContext({ storageState: resolvedPath })`
- If `auth.cdpUrl` is set: use `chromium.connectOverCDP(cdpUrl)` instead of `chromium.launch()`
- Validate the file exists before starting the session; error clearly if missing

### 4. Auth State Refresh

Auth tokens expire. Handle this by:
- Logging a warning if the storageState file is older than 24 hours
- Providing `abra auth refresh <name>` as an alias for re-running the capture
- If a session gets a 401/redirect-to-login during a run, log a clear error: "Auth state may be expired. Run `abra auth <name>` to refresh."

## Files to Modify

- `src/cli.ts` — Add `auth` subcommand
- `src/lib/session.ts` — Load storageState / connect via CDP when creating browser context
- `src/types.ts` (or equivalent) — Add `auth` field to persona config type
- New: `src/commands/auth.ts` — Auth capture command implementation
- New: `~/.abra/auth/` — Directory for stored auth state files

## Acceptance Criteria

- [ ] `abra auth <name>` opens a browser, waits for user login, saves state to `~/.abra/auth/<name>.json`
- [ ] Persona YAML with `auth.storageState: "<name>"` loads that state before navigating to the start URL
- [ ] Persona YAML with `auth.cdpUrl` connects to existing Chrome instead of launching a new browser
- [ ] Clear error messages when auth file is missing or expired
- [ ] Existing personas without `auth` field continue to work unchanged (no breaking changes)

## Out of Scope

- Automatic OAuth flow handling (headless login)
- Token refresh/rotation during a session
- Multi-account support within a single session
