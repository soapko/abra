# 008.bugfix: Shadow DOM Element Clicking

**Status:** Implemented and Tested
**Priority:** High
**Branch:** `feature/sight-based-analysis`

## Problem

When trying to click elements inside shadow DOM (e.g., dropdown suggestions, popovers, custom web components), the click fails because:

1. **Playwright actionability checks** report the element as "covered by" the shadow host
2. **Coordinate fallback** uses `document.elementFromPoint()` which returns the shadow host, not the element inside
3. The click event on the shadow host doesn't propagate to the actual target element inside the shadow DOM

## Reproduction

1. Run sight mode on Reddit: `node dist/cli.js run personas/reddit-sloth-test.yaml --sight-mode`
2. Type "sloths" in search box
3. Dropdown appears with r/sloths suggestion (element is detected and annotated correctly)
4. Click on dropdown item fails with "covered by reddit-search-large" or timeout
5. Coordinate fallback fires but clicks shadow host, not the actual link

## Root Cause Analysis

### Detection Works
- Shadow DOM elements ARE being detected (page goes from 70 â†’ 154 elements when dropdown opens)
- Elements inside shadow DOM ARE being annotated with red boxes and numbers
- LLM correctly identifies the element to click (e.g., element [47] = r/sloths link)

### Clicking Fails
- Selector `reddit-search-large >>> a` isn't valid Playwright syntax
- Playwright's click sees the element as "covered by" the shadow host
- `document.elementFromPoint(x, y)` returns the shadow host element, not the element inside
- Calling `.click()` on shadow host doesn't reach the actual target

## Affected Components

### abra (this project)
- `src/lib/page-analyzer.ts` - Generates `>>>` selectors for shadow DOM elements
- `src/lib/action-executor.ts` - Coordinate fallback can't pierce shadow DOM
- `src/cli.ts` - Mouse click implementation uses `elementFromPoint`

### puppet (dependency)
- No `force: true` option to bypass actionability checks
- No shadow DOM piercing support for clicks

## Proposed Solutions

### Option A: Fix in puppet (Recommended)
Add `force: true` option to puppet's click command that:
1. Bypasses Playwright's actionability checks (covered, visible, etc.)
2. Uses native click at coordinates via `page.mouse.click(x, y)`

```typescript
// In puppet
async click(selector: string, options?: { force?: boolean }): Promise<void> {
  if (options?.force) {
    const box = await this.page.locator(selector).boundingBox();
    if (box) {
      await this.page.mouse.click(box.x + box.width/2, box.y + box.height/2);
    }
  } else {
    await this.send('click', { selector });
  }
}
```

### Option B: Fix in abra (Workaround)
Detect shadow DOM elements and use alternative interaction:

1. **Press Enter for search forms**: After typing in a search box, press Enter instead of clicking dropdown suggestions
2. **Direct shadow DOM click**: Inject JavaScript that traverses shadow DOM to find and click the element:

```typescript
// For shadow DOM elements, inject script to click inside shadow root
await browser.evaluate(`
  const host = document.querySelector('reddit-search-large');
  const link = host?.shadowRoot?.querySelector('a[href*="sloths"]');
  link?.click();
`);
```

### Option C: Hybrid Approach
1. Add `force` option to puppet (long-term fix)
2. In abra, detect shadow DOM selectors (contains `>>>`) and:
   - First try coordinate click with native mouse
   - If that fails, try injecting shadow DOM traversal script
   - As last resort, substitute action (e.g., press Enter for search)

## Implementation Tasks

- [ ] **puppet**: Add `force: true` option to click command (not needed for now)
- [ ] **puppet**: Add native `page.mouse.click(x, y)` command (not needed for now)
- [x] **abra**: Update coordinate fallback to use shadow DOM piercing via `deepElementFromPoint`
- [x] **abra**: For link elements inside shadow DOM, extract href and navigate directly
- [x] **abra**: Detect when action will fail and suggest alternative (press Enter)
- [x] Test on Reddit search dropdown
- [ ] Test on other sites with shadow DOM (e.g., GitHub, YouTube)

## Solution Implemented

The fix is in `src/cli.ts` in the `mouse.click` implementation:

1. **`deepElementFromPoint(x, y)`**: Recursively pierces shadow DOM to find the actual element at coordinates:
   ```javascript
   function deepElementFromPoint(x, y) {
     let el = document.elementFromPoint(x, y);
     while (el.shadowRoot) {
       const inner = el.shadowRoot.elementFromPoint(x, y);
       if (!inner || inner === el) break;
       el = inner;
     }
     return el;
   }
   ```

2. **Direct navigation for links**: For `<a>` elements, extracts the href and navigates directly:
   ```javascript
   const link = el.closest('a[href]');
   if (link && link.href) {
     window.location.href = link.href;
   }
   ```

3. **Event dispatch for other elements**: Focus, then fire complete pointer/mouse event sequence

## Testing

1. Reddit sloth search - click dropdown suggestion
2. Any site with custom web components for search/dropdowns
3. Sites using Lit, Stencil, or other shadow DOM frameworks

## Acceptance Criteria

- [x] Can click elements inside shadow DOM popovers/dropdowns
- [x] Coordinate fallback works for shadow DOM elements
- [x] Reddit search test completes successfully (navigated to r/sloths)
- [x] No regression in non-shadow-DOM clicking

## Related

- Task 007: Unique selector generation (completed - but shadow DOM selectors aren't usable)
- Shadow DOM elements are detected but clicking them fails
