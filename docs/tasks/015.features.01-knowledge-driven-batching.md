# Task 21: Knowledge-driven batching

## Problem

Domain knowledge is only used for **backward assertions** (checking outcomes after actions). It's never surfaced to the LLM, so the LLM can't plan ahead based on what it learned from previous visits.

On visit 4, Abra should essentially have a playbook: "dismiss modal -> click Theme -> click Purple -> click Radius -> click Large" and blast through it. But the LLM can't see what's behind a dropdown until it opens — unless we tell it.

## Solution

Two changes:
1. **Inject domain knowledge into the LLM prompt** — summarize learned transitions so the LLM knows what will appear after each action
2. **Add `label` field to actions** — allow targeting elements by visible text for elements that don't exist yet but will appear after a preceding action

## Architecture

### Knowledge Summary (domain-knowledge.ts)

New method `getKnowledgeSummary(domain, pagePath)`:
- Filters transitions for the domain (all page paths — knowledge from `/` helps on `/docs`)
- Groups by action (click on "Theme", press Escape, etc.)
- For each action, describes what appears/disappears/changes
- Returns formatted string for prompt injection

Example output:
```
From previous visits, you know:
- Clicking "Get Started" button → a dialog/modal closes
- Clicking "Theme" button → dropdown appears with options including: "Default", "Purple", "Blue"
- Pressing Escape → closes the open dropdown
- Clicking "Large" text → selects the Large radius option
```

### Label-based Action Targeting (llm.ts, session.ts)

New `label` field on Action:
```json
{"type": "click", "label": "Purple"}
```

Resolution in `executeBatch()`:
1. When action has `label` but no `elementId`/`selector`
2. Wait for DOM to settle
3. Re-run page analyzer to get fresh elements
4. Find element whose text/ariaLabel/testId matches the label
5. Execute with resolved selector
6. If not found, bail with "label not resolved"

### Prompt Changes (llm.ts)

System prompts updated to:
- Explain domain knowledge section
- Explain `label` field for forward-targeting
- Emphasize: "use knowledge to batch aggressively"

User prompts updated to:
- Include `DOMAIN KNOWLEDGE` section when knowledge exists
- Placed after `CURRENT GOAL` and before `PAGE ELEMENTS`

## Files Changed

1. `src/lib/domain-knowledge.ts` — `getKnowledgeSummary()` + helpers
2. `src/lib/llm.ts` — `label` on Action, `domainKnowledge` param on prompts, system prompt updates
3. `src/lib/session.ts` — query knowledge, pass to LLM, label resolution in executeBatch

## Dependencies

- Task 18 (Domain Knowledge) — uses existing transition records
- Task 17 (Batch Execution) — extends with label resolution
