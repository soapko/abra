# Task 24: Adaptive Focus Screenshots for Sight Mode

## Context

Abra's sight mode takes a full viewport screenshot (1440x900) every cycle. When the persona is interacting with a small UI component — a dropdown with 200x300 pixels of options, a modal form, a color picker — the vision LLM gets a lot of visual noise. The interesting area is a fraction of the total pixels. Meanwhile, Puppet now supports `clip` screenshots that capture specific regions of the viewport.

## Goal

Make sight mode adaptively focus its screenshot on the region that matters. When a dropdown opens or a modal appears, take a focused screenshot of just that area. The LLM gets higher effective resolution on the elements it needs to identify, with less noise from irrelevant page content.

## Design

### Core Concept: Region of Interest (ROI)

After each action, compare the previous element set to the current one. New elements that appeared (portal content, dropdown options, modal contents) define a **region of interest**. When the ROI is small relative to the viewport (< 50% of area), take a **focused clip screenshot** of just that region instead of the full viewport.

### When to Use Focused vs Full Viewport

| Condition | Screenshot Type |
|-----------|----------------|
| First iteration (no previous elements) | Full viewport |
| No new elements appeared | Full viewport |
| New elements appeared, ROI < 50% of viewport | **Focused clip** |
| New elements appeared, ROI >= 50% of viewport | Full viewport |

### How It Works

1. **Track previous elements** — After each sensing cycle, store the element IDs
2. **Detect new elements** — Compare current elements to previous; find ones that weren't there before
3. **Compute ROI bounding box** — Union of all new elements' bounds + the trigger element (last-clicked), with padding
4. **Take focused screenshot** — `browser.screenshot({ clip: roi })` captures just the ROI
5. **Annotate only ROI elements** — Inject annotations only for elements within the clip region (less visual clutter)
6. **Offset coordinates** — When LLM returns x/y coordinate clicks, offset by ROI origin to get viewport coordinates
7. **Legend marks focus** — Element legend indicates which elements are in the focused view vs outside it

### Coordinate Mapping

When the LLM sees a focused screenshot, any x/y coordinates it returns are relative to the clip region, not the full viewport:

```
viewport_x = clip.x + returned_x
viewport_y = clip.y + returned_y
```

The `elementId` path is unaffected — IDs always map to the full element list.

### Element Legend Enhancement

When a focused screenshot is active, the legend marks elements as in-view or off-screen:

```
FOCUSED VIEW: Zoomed into dropdown area (x:400 y:280 w:300 h:350)
Elements in view (annotated):
  [33] Button "Theme" @center
  [105] div "Purple" @center
  [107] div "Fuchsia" @center
  [108] div "Green" @center

Other elements (not shown in screenshot):
  [0] Link "Home" @top-left
  [1] Button "Get Started" @top-right
  ...
```

## Implementation

### Layer 1: BrowserInterface Update

**File: `src/lib/action-executor.ts`**

Add screenshot options:

```typescript
export interface ScreenshotOptions {
  clip?: { x: number; y: number; width: number; height: number };
  selector?: string;
  fullPage?: boolean;
}

export interface Browser {
  screenshot(options?: ScreenshotOptions): Promise<Buffer | string>;
  // ... rest unchanged
}
```

### Layer 2: ROI Detection

**File: `src/lib/session.ts`**

New function:

```typescript
interface ClipRegion {
  x: number;
  y: number;
  width: number;
  height: number;
}

function computeRegionOfInterest(
  previousElementIds: Set<number>,
  currentElements: PageElement[],
  lastClickedElement: PageElement | null,
  viewport: { width: number; height: number }
): ClipRegion | null
```

Logic:
- Find elements in current set whose IDs weren't in the previous set
- If < 3 new elements, no ROI (too minor a change)
- Compute bounding box of all new elements
- If last-clicked element exists, include it in the bounding box (shows trigger + content)
- Add 50px padding on all sides
- Clamp to viewport bounds
- If ROI area >= 50% of viewport area, return null (not worth focusing)

### Layer 3: Focused Screenshot Capture

**File: `src/lib/session.ts`** (sight mode block)

```typescript
// Track previous elements across iterations
let previousElementIds = new Set<number>();
let activeClip: ClipRegion | null = null;

// In sight mode block:
const roi = computeRegionOfInterest(
  previousElementIds, pageState.elements, targetElement, viewport
);

if (roi) {
  activeClip = roi;
  // Annotate ONLY elements within the clip region
  const roiElements = pageState.elements.filter(el => isElementInRegion(el, roi));
  await browser.evaluate(getAnnotationScript(roiElements));
  const screenshot = await browser.screenshot({ clip: roi });
  await browser.evaluate(getRemoveAnnotationScript());
  const elementLegend = formatFocusedElementLegend(pageState.elements, roi);
  // ... call getNextActionFromScreenshot with focusedLegend
} else {
  activeClip = null;
  // Full viewport (current behavior)
}

// After action resolution, update previous elements
previousElementIds = new Set(pageState.elements.map(el => el.id));
```

### Layer 4: Coordinate Offset

**File: `src/lib/session.ts`** (vision result processing)

When resolving vision actions with x/y coordinates:

```typescript
if (vAction.x !== undefined && vAction.y !== undefined && activeClip) {
  // Offset from clip-relative to viewport-relative
  return {
    ...vAction,
    sourceX: activeClip.x + vAction.x,
    sourceY: activeClip.y + vAction.y,
  };
}
```

### Layer 5: Enhanced Element Legend

**File: `src/lib/screenshot-annotator.ts`**

New function `formatFocusedElementLegend(elements, clip)`:
- Groups elements into "in view" and "off-screen"
- Adds header describing the focused region
- Elements in view are listed first (these have annotations in the screenshot)
- Off-screen elements listed after (LLM can still reference by ID)

### Layer 6: Vision Prompt Update

**File: `src/lib/llm.ts`**

Add to the vision system prompt:
- Explain that the screenshot may be a zoomed-in view of a specific area
- When focused: "You are seeing a zoomed-in view of [area]. Elements outside this view are listed in the legend but not visible in the screenshot."
- Coordinate caveat: "If using x/y coordinates, they are relative to the visible area, not the full viewport."

## Testing

- Run against shadcn customizer with sight mode
- Verify: when Theme dropdown opens, screenshot focuses on the dropdown area
- Verify: LLM can identify and select color options from the focused view
- Verify: coordinate fallback clicks are properly offset to viewport space
- Verify: first iteration uses full viewport
- Verify: closing dropdown (no new elements) reverts to full viewport

## Depends On

- Task 12: Sight mode (base feature)
- Task 20: Portal scanning (ensures dropdown elements are discovered)
- Puppet screenshot `clip` option (already implemented)

## Files Changed

- `src/lib/action-executor.ts` — ScreenshotOptions type, Browser interface update
- `src/lib/session.ts` — ROI detection, focused screenshot capture, coordinate offset
- `src/lib/screenshot-annotator.ts` — formatFocusedElementLegend, isElementInRegion helper
- `src/lib/llm.ts` — Vision prompt update for focused screenshots
