# Task: Portal Scanning + Vision Coordinate Fallback

**ID:** 014.bugfix.01
**Status:** In Progress
**Depends on:** None (fixes existing functionality)

## Problem

When Abra uses sight mode on sites with Radix UI (shadcn/ui), it can't interact with elements inside portal containers (popovers, dropdowns, select menus). Two compounding issues:

1. **Page analyzer doesn't scan portal containers.** Radix UI renders popovers/dropdowns as direct children of `document.body` via React portals. These elements have attributes like `[data-radix-popper-content-wrapper]`, `[data-radix-portal]`, `[data-radix-menu-content]`. The page analyzer searches the regular DOM and shadow DOM but skips these portal containers entirely. Elements inside them are never discovered, never assigned IDs.

2. **Vision prompt forbids coordinate clicks.** The vision system prompt says "Do NOT guess coordinates." When the LLM sees unannotated interactive elements in the screenshot (like color dots in a popover), it has no mechanism to click them. The action executor already supports coordinate-based clicks (`browser.mouse.click(x, y)`), but the LLM is never allowed to use them.

## Fix

### Layer 1: Page Analyzer Portal Scanning

Add portal container scanning to `PAGE_ANALYZER_SCRIPT` in `src/lib/page-analyzer.ts`.

Search for portal containers using these selectors:
- `[data-radix-popper-content-wrapper]` — Radix popover/dropdown wrapper
- `[data-radix-portal]` — Radix portal root
- `[data-floating-ui-portal]` — Floating UI portals
- `[data-headlessui-portal]` — Headless UI portals
- `[role="dialog"]` — Modal dialogs
- `[role="listbox"]` — Select/combobox dropdowns
- `[role="menu"]` — Dropdown menus

For each found container, run the same interactive element search inside it.

### Layer 2: Vision Coordinate Fallback

Modify `buildVisionSystemPrompt()` in `src/lib/llm.ts` to allow coordinate-based clicks as a fallback:

Add to the vision prompt:
```
COORDINATE FALLBACK:
If you see an interactive element in the screenshot that has NO red numbered label
(e.g., color swatches, popover items, dropdown options that appeared after an action),
you may specify a coordinate-based click using "x" and "y" fields instead of "elementId":
{"type": "click", "x": 450, "y": 320}
Estimate coordinates from the screenshot. Only use this when no annotated element covers what you need.
```

Update `parseVisionResponse()` to pass through `x`/`y` fields.

Update the sight mode action resolution in `session.ts` to handle coordinate-based actions (skip element lookup, pass coordinates directly).

## Testing

Run against `https://ui.shadcn.com/create?style=vega` with the shadcn-customizer persona. Verify:
- Portal elements (color dots in popovers) are discovered and annotated
- If still not annotated, the LLM uses coordinate fallback to click them
- The persona can successfully change the color theme to purple
